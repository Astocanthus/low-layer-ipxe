server {
    listen 80;
    server_name _;
    
    # Authentification basique
    auth_basic "iPXE Server";
    auth_basic_user_file /etc/nginx/auth/.htpasswd;

    # Répertoire pour les images système
    location /images/ {
        alias /var/www/images/;
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
        
        # Headers pour les images
        location ~* \.(iso|img|vmdk|qcow2)$ {
            add_header Content-Type "application/octet-stream";
            add_header Cache-Control "public, max-age=3600";
        }
    }

    # Répertoire pour les fichiers Ignition
    location /ignition/ {
        alias /var/www/ignition/;
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
        
        # Content-type spécifique pour Ignition
        location ~* \.ign$ {
            default_type "application/vnd.coreos.ignition+json";
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        }
    }

    # Page de statut simple
    location / {
        return 200 "iPXE Server - OK\nImages: /images/\nIgnition: /ignition/\n";
        add_header Content-Type text/plain;
    }

    # Sécurité - bloquer l'accès aux fichiers sensibles
    location ~ /\. {
        deny all;
    }
    
    location ~ /\.htpasswd {
        deny all;
    }
}